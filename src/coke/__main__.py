from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import create_engine
from sqlalchemy import Column, Integer, Text, Identity, VARCHAR, PrimaryKeyConstraint, CheckConstraint
from sqlalchemy.orm import sessionmaker

engine = create_engine('postgresql://felnne@localhost/pytest_alembic')
base = declarative_base()
base.metadata.create_all(engine)


class Foo(base):
    __tablename__ = 'foo'
    __table_args__ = {
        'comment': 'Foo'
    }

    id = Column("id", Integer, Identity(), primary_key=True, comment="ID")
    label = Column("label", Text, nullable=False, comment='Label')

    def __repr__(self):
        return f"<Foo [{self.id}] '{self.label}'>"


class PostGISSpatialRefSys(base):
    """
    Utility table generated by the PostGIS extension.

    Needed for the DDL migration test to pass. It is never used from within code and can be safely ignored.
    """
    __tablename__ = 'spatial_ref_sys'
    __table_args__ = (
        PrimaryKeyConstraint('srid', name='spatial_ref_sys_pkey'),
        CheckConstraint('(srid > 0) AND (srid <= 998999)', name='spatial_ref_sys_srid_check'),
    )

    srid = Column('srid', Integer, autoincrement=False, nullable=False)
    auth_name = Column('auth_name', VARCHAR(length=256), autoincrement=False, nullable=True)
    auth_srid = Column('auth_srid', Integer, autoincrement=False, nullable=True)
    srtext = Column('srtext', VARCHAR(length=2048), autoincrement=False, nullable=True)
    proj4text = Column('proj4text', VARCHAR(length=2048), autoincrement=False, nullable=True)


def main():
    session_maker = sessionmaker(bind=engine)
    session = session_maker()

    foo1 = Foo(label='one')
    foo2 = Foo(label='two')
    foo3 = Foo(label='three')

    session.add_all([foo1, foo2, foo3])
    session.commit()
    print("insert - ok")

    session.query(Foo).filter(Foo.label == foo1.label).one()
    print("retrieve - ok")

    foo2_new_label = 'twotwo'
    foo2.label = foo2_new_label
    session.commit()
    session.query(Foo).filter(Foo.label == foo2.label).one()
    print("update - ok")

    session.delete(foo3)
    session.commit()
    if session.query(Foo).filter(Foo.label == foo3.label).one_or_none() is None:
        print("delete - ok")


if __name__ == "__main__":
    main()
